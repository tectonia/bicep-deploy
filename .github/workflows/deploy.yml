name: Deploy Bicep Template

on:
  push:
    branches:
      - main
      - dev

env:
  TEMPLATE-FILE: main.bicep

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: Dev
    #if: ${{ github.ref == 'refs/heads/dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'

      - name: Deploy to Dev
        uses: Azure/arm-deploy@v1.0.9
        with:
          template: ${{ env.TEMPLATE-FILE }}
          parameters: 'main-dev.parameters.json'
          resourceGroupName: ${{ env.DEV_RESOURCE_GROUP }}
          region: uksouth

  deploy-prod:
    runs-on: ubuntu-latest
    environment:
      name: Prod
    #if: ${{ github.ref == 'refs/heads/main' }}
    needs: deploy-dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'

      - name: Deploy to Prod
        uses: azure/bicep-actions/deploy@v0
        with:
          template: ${{ env.TEMPLATE-FILE }}
          parameters: 'main-prod.parameters.json'
          resourceGroupName: ${{ env.PROD_RESOURCE_GROUP }}
          region: uksouth
